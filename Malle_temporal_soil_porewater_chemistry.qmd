---
title: "Malle temporal soil porewater chemistry"
author: "Teneille Nel"
format: pdf
editor: visual
---

## ROCMICS

Teneille's data analysis repository is available at <https://github.com/Teneille97/rocmics>.

## Malle soil and porewater chemistry

Summarising over plot replicates, considering **no dose-response treatments** except control, and rendering with `ggthemr('flat dark')`, displays these plots (note **still awaiting** porewater elements, nutrients and alkalinity data):

```{r}
#| echo: false
#| message: false
#| label: soil and porewater chemistry plots
#| warning: FALSE

#load packages
library(ggplot2)
library(gganimate)
library(viridis)
library(RColorBrewer)
library(tidyverse)
library(dplyr)
library(car)
library(lme4)
library(zoo)
library(ggthemr)
theme_update(
  legend.title = element_text(size = 10),
  legend.text  = element_text(size = 8)
)
library(gridExtra)

#set theme
ggthemr('flat dark')


#import files
Alldata_Rhizon<-read.csv("csv_files/Alldata_Rhizon.csv", header = T) #NB change sep settings on other laptop
Alldata_Soil_phEC<-read.csv("csv_files/Alldata_Soil_phEC.csv", header = T)
Alldata_PRS<-read.csv("csv_files/Alldata_PRS.csv", header = T)


#data cleaning
Alldata_Rhizon<-Alldata_Rhizon[1:252,]
Alldata_Rhizon <- Alldata_Rhizon %>%
  mutate(across(c(Treatment, Dose_response_exp.), as.factor)) #convert chr to factor

Alldata_Rhizon <- Alldata_Rhizon %>%
  separate(
    col = Treatment,       
    into = c("Tmt", "App_rate"), 
    sep = "_"              
  ) %>%
  mutate(
    App_rate = replace_na(App_rate, "0") 
  )

Alldata_Rhizon$Tmt<-as.factor(Alldata_Rhizon$Tmt)
Alldata_Rhizon$Sampled_on<-as.Date(Alldata_Rhizon$Sampled_on,format = "%Y/%m/%d") 
#coerce ecosphere data char to num
start_col <- which(names(Alldata_Rhizon) == "Alkalinity_mg_l_CaCO3")
Alldata_Rhizon[start_col:ncol(Alldata_Rhizon)] <- 
  lapply(Alldata_Rhizon[start_col:ncol(Alldata_Rhizon)], \(x) as.numeric(trimws(x)))

#summary
Alldata_Rhizon_summary <- Alldata_Rhizon %>%
  group_by(Sampled_on, Tmt, App_rate) %>%
  summarise(
    across(
      c(pH, EC_µS_cm, DOC, DIC, Alkalinity_meq_l, NO2.N_mgN_l, NH4.N_mgN_l,
        NO3.N_mgN_l, PO4.P_mgP_l, Cl_mgCl_l, Ca_mg_l, Fe_mg_l, K_mg_l, 
        Mg_mg_l, Na_mg_l, Ni_mg_l, P_mg_l, Al_mg_l, Si_mg_l),
      list(
        mean = ~ mean(.x, na.rm = TRUE),
        se   = ~ sd(.x, na.rm = TRUE) / sqrt(n())
      ),
      .names = "{.fn}_{.col}"
    ),
    .groups = "drop"
  )

Alldata_Soil_phEC <- Alldata_Soil_phEC %>%
  mutate(across(c(Pot, Plot, Treatment, Dose_response_exp.), as.factor)) #convert chr to factor

Alldata_Soil_phEC <- Alldata_Soil_phEC %>%
  separate(
    col = Treatment,       # The column to split
    into = c("Tmt", "App_rate"), # The names of the new columns
    sep = "_"              # The separator character in your data
  ) %>%
  mutate(
    App_rate = replace_na(App_rate, "0") 
  )

Alldata_Soil_phEC$Date<-as.Date(Alldata_Soil_phEC$Date, format = "%Y/%m/%d")
Alldata_Soil_phEC$Tmt<-as.factor(Alldata_Soil_phEC$Tmt)

Alldata_Soil_phEC_summary <- Alldata_Soil_phEC %>%
  group_by(Date, Tmt, App_rate) %>%
  summarise(
    mean_pH = mean(pH, na.rm = TRUE),
    se_pH   = sd(pH, na.rm = TRUE) / sqrt(n()),
    
    mean_EC = mean(EC, na.rm = TRUE),
    se_EC   = sd(EC, na.rm = TRUE) / sqrt(n()),
    
    .groups = "drop"
  )

Alldata_Soil_phEC_summary$Date<-as.Date(Alldata_Soil_phEC_summary$Date, format = "%d/%m/%Y")

#plotting
soilpH_plot <- Alldata_Soil_phEC_summary %>%
  dplyr::filter(
    (Tmt == "Control" & App_rate == "0") |
      (Tmt == "Lime"    & App_rate == "02") |
      (Tmt == "Bolsdorfer"  & App_rate == "50") |
      (Tmt == "Eifelgold"  & App_rate == "50") |
      (Tmt == "Huhnerberg"  & App_rate == "50") 
  ) %>%
  ggplot(aes(x = Date, y = mean_pH, colour = Tmt)) +
  geom_point(size = 4) +
  geom_errorbar(aes(ymin = mean_pH - se_pH,
                    ymax = mean_pH + se_pH),
                width = 0.1) +
  scale_x_date(
    breaks = "3 months",  
    date_labels = "%b %Y"
  ) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1)
  ) + 
  labs(
    y = "Soil pH", 
    title = "Soil pH over time",
    colour = "Treatment"
  )

soilEC_plot <- Alldata_Soil_phEC_summary %>%
  dplyr::filter(
    (Tmt == "Control" & App_rate == "0") |
      (Tmt == "Lime"    & App_rate == "02") |
      (Tmt == "Bolsdorfer"  & App_rate == "50") |
      (Tmt == "Eifelgold"  & App_rate == "50") |
      (Tmt == "Huhnerberg"  & App_rate == "50") 
  ) %>%
  ggplot(aes(x = Date, y = mean_EC, colour = Tmt)) +
  geom_point(size = 4) +
  geom_errorbar(aes(ymin = mean_EC - se_EC,
                    ymax = mean_EC + se_EC),
                width = 0.1) +
  scale_x_date(
    breaks = "3 months",  
    date_labels = "%b %Y"
  ) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1)
  ) + 
  labs(
    y = "Soil EC (uS/cm)",
    title = "Soil EC over time",
    colour = "Treatment"
  )

rhizon_pH_plot <- Alldata_Rhizon_summary %>%
  dplyr::filter(
    (Tmt == "Control" & App_rate == "0") |
      (Tmt == "Lime"    & App_rate == "02") |
      (Tmt == "Bolsdorfer"  & App_rate == "50") |
      (Tmt == "Eifelgold"  & App_rate == "50") |
      (Tmt == "Huhnerberg"  & App_rate == "50") 
  ) %>%
  ggplot(aes(x = Sampled_on, y = mean_pH, colour = Tmt)) +
  geom_point(size = 4) +
  geom_errorbar(aes(ymin = mean_pH - se_pH,
                    ymax = mean_pH + se_pH),
                width = 0.1) +
  scale_x_date(
    breaks = "3 months",  
    date_labels = "%b %Y"
  ) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1)
  ) + 
  labs(
    y = "Porewater pH", 
    title = "Porewater pH over time",
    colour = "Treatment"
  )

rhizon_EC_plot <- Alldata_Rhizon_summary %>%
  dplyr::filter(
    (Tmt == "Control" & App_rate == "0") |
      (Tmt == "Lime"    & App_rate == "02") |
      (Tmt == "Bolsdorfer"  & App_rate == "50") |
      (Tmt == "Eifelgold"  & App_rate == "50") |
      (Tmt == "Huhnerberg"  & App_rate == "50") 
  ) %>%
  ggplot(aes(x = Sampled_on, y = mean_EC_µS_cm, colour = Tmt)) +
  geom_point(size = 4) +
  geom_errorbar(aes(ymin = mean_EC_µS_cm - se_EC_µS_cm,
                    ymax = mean_EC_µS_cm + se_EC_µS_cm),
                width = 0.1) +
  scale_x_date(
    breaks = "3 months",  
    date_labels = "%b %Y"
  ) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1)
  ) + 
  labs(
    y = "Porewater EC (uS/cm)", 
    x = "Date",
    title = "Porewater EC over time (no outliers 2nd sampling)",
    colour = "Treatment"
  ) +
  ylim(0,750)


rhizon_DIC_plot <- Alldata_Rhizon_summary %>%
  dplyr::filter(
    (Tmt == "Control" & App_rate == "0") |
      (Tmt == "Lime"    & App_rate == "02") |
      (Tmt == "Bolsdorfer"  & App_rate == "50") |
      (Tmt == "Eifelgold"  & App_rate == "50") |
      (Tmt == "Huhnerberg"  & App_rate == "50") 
  ) %>%
  ggplot(aes(x = Sampled_on, y = mean_DIC, colour = Tmt)) +
  geom_point(size = 4) +
  geom_errorbar(aes(ymin = mean_DIC - se_DIC,
                    ymax = mean_DIC + se_DIC),
                width = 0.1) +
  scale_x_date(
    breaks = "3 months",  
    date_labels = "%b %Y"
  ) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1)
  ) + 
  labs(
    y = "Porewater DIC (ppm)", 
    x = "Date",
    title = "Porewater DIC over time",
    colour = "Treatment"
  ) 

rhizon_DOC_plot <- Alldata_Rhizon_summary %>%
  dplyr::filter(
    (Tmt == "Control" & App_rate == "0") |
      (Tmt == "Lime"    & App_rate == "02") |
      (Tmt == "Bolsdorfer"  & App_rate == "50") |
      (Tmt == "Eifelgold"  & App_rate == "50") |
      (Tmt == "Huhnerberg"  & App_rate == "50") 
  ) %>%
  ggplot(aes(x = Sampled_on, y = mean_DOC, colour = Tmt)) +
  geom_point(size = 4) +
  geom_errorbar(aes(ymin = mean_DOC - se_DOC,
                    ymax = mean_DOC + se_DOC),
                width = 0.1) +
  scale_x_date(
    breaks = "3 months",  
    date_labels = "%b %Y"
  ) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1)
  ) + 
  labs(
    y = "Porewater DOC (ppm)", 
    x = "Date",
    title = "Porewater DOC over time",
    colour = "Treatment"
  ) 

rhizon_alkalinity_plot <- Alldata_Rhizon_summary %>%
  dplyr::filter(
    (Tmt == "Control" & App_rate == "0") |
      (Tmt == "Lime"    & App_rate == "02") |
      (Tmt == "Bolsdorfer"  & App_rate == "50") |
      (Tmt == "Eifelgold"  & App_rate == "50") |
      (Tmt == "Huhnerberg"  & App_rate == "50") 
  ) %>%
  ggplot(aes(x = Sampled_on, y = mean_Alkalinity_meq_l, colour = Tmt)) +
  geom_point(size = 4) +
  geom_errorbar(aes(ymin = mean_Alkalinity_meq_l - se_Alkalinity_meq_l,
                    ymax = mean_Alkalinity_meq_l + se_Alkalinity_meq_l),
                width = 0.1) +
  scale_x_date(
    breaks = "3 months",  
    date_labels = "%b %Y"
  ) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1)
  ) + 
  labs(
    y = "Porewater alkalinity (meq/L)", 
    x = "Date",
    title = "Porewater alkalinity over time",
    colour = "Treatment"
  ) 

rhizon_Ca_plot <- Alldata_Rhizon_summary %>%
  dplyr::filter(
    (Tmt == "Control" & App_rate == "0") |
      (Tmt == "Lime"    & App_rate == "02") |
      (Tmt == "Bolsdorfer"  & App_rate == "50") |
      (Tmt == "Eifelgold"  & App_rate == "50") |
      (Tmt == "Huhnerberg"  & App_rate == "50") 
  ) %>%
  ggplot(aes(x = Sampled_on, y = mean_Ca_mg_l, colour = Tmt)) +
  geom_point(size = 4) +
  geom_errorbar(aes(ymin = mean_Ca_mg_l - se_Ca_mg_l,
                    ymax = mean_Ca_mg_l + se_Ca_mg_l),
                width = 0.1) +
  scale_x_date(
    breaks = "3 months",  
    date_labels = "%b %Y"
  ) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1)
  ) + 
  labs(
    y = "Porewater Ca (mg/L)", 
    x = "Date",
    title = "Porewater Ca over time",
    colour = "Treatment"
  ) 

rhizon_Mg_plot <- Alldata_Rhizon_summary %>%
  dplyr::filter(
    (Tmt == "Control" & App_rate == "0") |
      (Tmt == "Lime"    & App_rate == "02") |
      (Tmt == "Bolsdorfer"  & App_rate == "50") |
      (Tmt == "Eifelgold"  & App_rate == "50") |
      (Tmt == "Huhnerberg"  & App_rate == "50") 
  ) %>%
  ggplot(aes(x = Sampled_on, y = mean_Mg_mg_l, colour = Tmt)) +
  geom_point(size = 4) +
  geom_errorbar(aes(ymin = mean_Mg_mg_l - se_Mg_mg_l,
                    ymax = mean_Mg_mg_l + se_Mg_mg_l),
                width = 0.1) +
  scale_x_date(
    breaks = "3 months",  
    date_labels = "%b %Y"
  ) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1)
  ) + 
  labs(
    y = "Porewater Mg (mg/L)", 
    x = "Date",
    title = "Porewater Mg over time",
    colour = "Treatment"
  ) 

rhizon_K_plot <- Alldata_Rhizon_summary %>%
  dplyr::filter(
    (Tmt == "Control" & App_rate == "0") |
      (Tmt == "Lime"    & App_rate == "02") |
      (Tmt == "Bolsdorfer"  & App_rate == "50") |
      (Tmt == "Eifelgold"  & App_rate == "50") |
      (Tmt == "Huhnerberg"  & App_rate == "50") 
  ) %>%
  ggplot(aes(x = Sampled_on, y = mean_K_mg_l, colour = Tmt)) +
  geom_point(size = 4) +
  geom_errorbar(aes(ymin = mean_K_mg_l - se_K_mg_l,
                    ymax = mean_K_mg_l + se_K_mg_l),
                width = 0.1) +
  scale_x_date(
    breaks = "3 months",  
    date_labels = "%b %Y"
  ) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1)
  ) + 
  labs(
    y = "Porewater K (mg/L)", 
    x = "Date",
    title = "Porewater K over time",
    colour = "Treatment"
  ) 

rhizon_Na_plot <- Alldata_Rhizon_summary %>%
  dplyr::filter(
    (Tmt == "Control" & App_rate == "0") |
      (Tmt == "Lime"    & App_rate == "02") |
      (Tmt == "Bolsdorfer"  & App_rate == "50") |
      (Tmt == "Eifelgold"  & App_rate == "50") |
      (Tmt == "Huhnerberg"  & App_rate == "50") 
  ) %>%
  ggplot(aes(x = Sampled_on, y = mean_Na_mg_l, colour = Tmt)) +
  geom_point(size = 4) +
  geom_errorbar(aes(ymin = mean_Na_mg_l - se_Na_mg_l,
                    ymax = mean_Na_mg_l + se_Na_mg_l),
                width = 0.1) +
  scale_x_date(
    breaks = "3 months",  
    date_labels = "%b %Y"
  ) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1)
  ) + 
  labs(
    y = "Porewater Na (mg/L)", 
    x = "Date",
    title = "Porewater Na over time",
    colour = "Treatment"
  ) 

rhizon_Fe_plot <- Alldata_Rhizon_summary %>%
  dplyr::filter(
    (Tmt == "Control" & App_rate == "0") |
      (Tmt == "Lime"    & App_rate == "02") |
      (Tmt == "Bolsdorfer"  & App_rate == "50") |
      (Tmt == "Eifelgold"  & App_rate == "50") |
      (Tmt == "Huhnerberg"  & App_rate == "50") 
  ) %>%
  ggplot(aes(x = Sampled_on, y = mean_Fe_mg_l, colour = Tmt)) +
  geom_point(size = 4) +
  geom_errorbar(aes(ymin = mean_Fe_mg_l - se_Fe_mg_l,
                    ymax = mean_Fe_mg_l + se_Fe_mg_l),
                width = 0.1) +
  scale_x_date(
    breaks = "3 months",  
    date_labels = "%b %Y"
  ) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1)
  ) + 
  labs(
    y = "Porewater Fe (mg/L)", 
    x = "Date",
    title = "Porewater Fe over time",
    colour = "Treatment"
  ) 

rhizon_Al_plot <- Alldata_Rhizon_summary %>%
  dplyr::filter(
    (Tmt == "Control" & App_rate == "0") |
      (Tmt == "Lime"    & App_rate == "02") |
      (Tmt == "Bolsdorfer"  & App_rate == "50") |
      (Tmt == "Eifelgold"  & App_rate == "50") |
      (Tmt == "Huhnerberg"  & App_rate == "50") 
  ) %>%
  ggplot(aes(x = Sampled_on, y = mean_Al_mg_l, colour = Tmt)) +
  geom_point(size = 4) +
  geom_errorbar(aes(ymin = mean_Al_mg_l - se_Al_mg_l,
                    ymax = mean_Al_mg_l + se_Al_mg_l),
                width = 0.1) +
  scale_x_date(
    breaks = "3 months",  
    date_labels = "%b %Y"
  ) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1)
  ) + 
  labs(
    y = "Porewater Al (mg/L)", 
    x = "Date",
    title = "Porewater Al over time",
    colour = "Treatment"
  ) 

plots <- list(soilpH_plot, soilEC_plot, rhizon_pH_plot, rhizon_EC_plot, rhizon_DIC_plot, rhizon_DOC_plot, rhizon_alkalinity_plot, rhizon_Ca_plot, rhizon_Mg_plot, rhizon_Na_plot, rhizon_K_plot, rhizon_Al_plot, rhizon_Fe_plot)  

multi_page <- marrangeGrob(
  grobs = plots,
  nrow = 1,
  ncol = 1,
  top = NULL,      # removes “page x” title 
  layout_matrix = matrix(1) # full-page plots
)
multi_page

```
